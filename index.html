<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICESOFT - Acceso al Sistema</title>
  <link rel="icon" href="assets/icesoft.png" type="image/png">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/alerts.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body class="login-page">
  <section class="form-main">
    <!-- FORMULARIO DE LOGIN -->
    <div class="recovery-container" id="loginContainer">
      <div class="recovery-content">
        <div class="recovery-header">
          <div class="recovery-logo">
            <img src="./assets/icesoft.png" alt="ICESOFT Logo" class="recovery-logo-img">
          </div>
          <h2>Iniciar Sesión</h2>
        </div>
        
        <div class="recovery-body">
          <form id="loginForm" novalidate>
            <div class="step-header">
              <div class="step-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </div>
              <h3>Acceso a la Plataforma</h3>
            </div>
            <p>Ingresa tus credenciales para acceder al sistema.</p>
            
            <div class="recovery-input-group">
              <label for="email">Correo Electrónico</label>
              <input type="email" id="email" placeholder="usuario@ejemplo.com" class="field-element">
              <div class="error-message" id="email-error"></div>
            </div>
            
            <div class="recovery-input-group">
              <label for="password">Contraseña</label>
              <input type="password" id="password" placeholder="••••••" class="field-element">
              <div class="error-message" id="password-error"></div>
            </div>
            
            <div class="recovery-actions">
              <button type="submit" class="recovery-btn primary-btn">Iniciar Sesión</button>
            </div>
            
            <div class="recovery-link">
              <a href="#" onclick="showRecoveryForm()">¿Olvidaste tu contraseña?</a>
            </div>
          </form>
        </div>
        
        <div class="recovery-footer">
          <p>© 2025 ICESOFT - Todos los derechos reservados</p>
        </div>
      </div>
    </div>
    
    <!-- FORMULARIO DE RECUPERACIÓN -->
    <div id="recoveryForm" class="recovery-container" style="display: none;">
      <div class="recovery-content">
        <div class="recovery-header">
          <div class="recovery-logo">
            <img src="./assets/icesoft.png" alt="ICESOFT Logo" class="recovery-logo-img">
          </div>
          <h2>Centro de Recuperación</h2>
        </div>
        
        <!-- Contenedor principal que cambia según el paso -->
        <div class="recovery-body">
          <!-- Paso 1: Ingreso de correo -->
          <div id="step-email" class="recovery-step active">
            <div class="step-header">
              <div class="step-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
              </div>
              <h3>Verificación de Email</h3>
            </div>
            <p>Ingresa tu correo electrónico registrado para comenzar el proceso de recuperación.</p>
            
            <div class="recovery-input-group">
              <label for="recoveryEmail">Correo Electrónico</label>
              <input type="email" id="recoveryEmail" placeholder="usuario@ejemplo.com" class="field-element">
              <div class="error-message" id="recoveryEmail-error"></div>
            </div>
            
            <div class="recovery-actions">
              <button type="button" class="recovery-btn primary-btn" onclick="verifyUserEmail()">Verificar Email</button>
            </div>
            
            <div class="recovery-link">
              <a href="#" onclick="showLoginForm()">Volver a inicio de sesión</a>
            </div>
          </div>
          
          <!-- Paso 2: Cambio de contraseña -->
          <div id="step-password" class="recovery-step">
            <div class="step-header">
              <div class="step-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
              </div>
              <h3>Nueva Contraseña</h3>
            </div>
            <p>Crea una contraseña segura de al menos 6 caracteres</p>
            
            <div class="recovery-input-group">
              <label for="newPassword">Nueva Contraseña</label>
              <input type="password" id="newPassword" placeholder="••••••" class="field-element">
              <div class="error-message" id="newPassword-error"></div>
            </div>
            
            <div class="recovery-input-group">
              <label for="confirmPassword">Confirmar Contraseña</label>
              <input type="password" id="confirmPassword" placeholder="••••••" class="field-element">
              <div class="error-message" id="confirmPassword-error"></div>
            </div>
            
            <div class="password-requirements">
              <p>La contraseña debe tener al menos 6 caracteres.</p>
            </div>
            
            <div class="recovery-actions">
              <button type="button" class="recovery-btn primary-btn" onclick="changePassword()">Actualizar Contraseña</button>
              <button type="button" class="recovery-btn secondary-btn" onclick="showEmailStep()">Regresar</button>
            </div>
          </div>
          
          <!-- Paso 3: Confirmación -->
          <div id="step-success" class="recovery-step">
            <div class="step-header success-header">
              <div class="step-icon success-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
              <h3>¡Contraseña Actualizada!</h3>
            </div>
            
            <div class="success-message">
              <p>Tu contraseña ha sido cambiada exitosamente. Ahora puedes acceder a tu cuenta con tu nueva contraseña.</p>
            </div>
            
            <div class="recovery-actions">
              <button type="button" class="recovery-btn success-btn" onclick="showLoginForm()">Ir a Iniciar Sesión</button>
            </div>
          </div>
          
          <!-- Mensaje de error -->
          <div id="step-error" class="recovery-step">
            <div class="step-header error-header">
              <div class="step-icon error-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </div>
              <h3>Error</h3>
            </div>
            
            <div class="error-message">
              <p id="error-message">No se pudo completar la operación.</p>
            </div>
            
            <div class="recovery-actions">
              <button type="button" class="recovery-btn error-btn" onclick="showEmailStep()">Intentar Nuevamente</button>
              <button type="button" class="recovery-btn secondary-btn" onclick="showLoginForm()">Volver al Inicio</button>
            </div>
          </div>
          
          <!-- Indicador de carga -->
          <div id="step-loading" class="recovery-step">
            <div class="step-header">
              <h3>Procesando solicitud</h3>
            </div>
            
            <div class="loader-container">
              <div class="progress">
                <div class="progress-bar"></div>
              </div>
              <p>Por favor espera mientras procesamos tu solicitud...</p>
            </div>
          </div>
        </div>
        
        <div class="recovery-footer">
          <p>© 2025 ICESOFT - Todos los derechos reservados</p>
        </div>
      </div>
    </div>
  </section>

  <!-- SCRIPTS DE FUNCIONALIDAD -->
  <script src="js/login.js"></script>
  <script src="js/forgot-password.js"></script>
  
  <script>
    // Script para validación de formularios y recuperación de contraseña
    document.addEventListener('DOMContentLoaded', function() {
      // ===== FUNCIONES DE VALIDACIÓN =====
      
      // Función para validar un campo y mostrar error
      function validateField(fieldId, errorMessage) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);
        
        if (!field.value.trim()) {
          errorElement.textContent = errorMessage || "El campo es obligatorio.";
          errorElement.style.display = "block";
          field.classList.add("input-error");
          return false;
        } else {
          errorElement.textContent = "";
          errorElement.style.display = "none";
          field.classList.remove("input-error");
          return true;
        }
      }

      // Función para validar email
      function validateEmail(fieldId) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!field.value.trim()) {
          errorElement.textContent = "El correo electrónico es obligatorio.";
          errorElement.style.display = "block";
          field.classList.add("input-error");
          return false;
        } else if (!emailRegex.test(field.value.trim())) {
          errorElement.textContent = "El formato del correo electrónico no es válido.";
          errorElement.style.display = "block";
          field.classList.add("input-error");
          return false;
        } else {
          errorElement.textContent = "";
          errorElement.style.display = "none";
          field.classList.remove("input-error");
          return true;
        }
      }

      // Función para validar contraseña
      function validatePassword(fieldId, minLength = 6) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);
        
        if (!field.value.trim()) {
          errorElement.textContent = "La contraseña es obligatoria.";
          errorElement.style.display = "block";
          field.classList.add("input-error");
          return false;
        } else if (minLength && field.value.trim().length < minLength) {
          errorElement.textContent = `La contraseña debe tener al menos ${minLength} caracteres.`;
          errorElement.style.display = "block";
          field.classList.add("input-error");
          return false;
        } else {
          errorElement.textContent = "";
          errorElement.style.display = "none";
          field.classList.remove("input-error");
          return true;
        }
      }

      // Función para validar confirmación de contraseña
      function validatePasswordMatch(passwordFieldId, confirmFieldId) {
        const passwordField = document.getElementById(passwordFieldId);
        const confirmField = document.getElementById(confirmFieldId);
        const errorElement = document.getElementById(`${confirmFieldId}-error`);
        
        if (!confirmField.value.trim()) {
          errorElement.textContent = "La confirmación es obligatoria.";
          errorElement.style.display = "block";
          confirmField.classList.add("input-error");
          return false;
        } else if (passwordField.value.trim() !== confirmField.value.trim()) {
          errorElement.textContent = "Las contraseñas no coinciden.";
          errorElement.style.display = "block";
          confirmField.classList.add("input-error");
          return false;
        } else {
          errorElement.textContent = "";
          errorElement.style.display = "none";
          confirmField.classList.remove("input-error");
          return true;
        }
      }

      // Limpiar mensajes de error
      function clearValidationErrors(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        const errorElements = form.querySelectorAll('.error-message');
        const inputElements = form.querySelectorAll('.field-element');
        
        errorElements.forEach(element => {
          element.textContent = "";
          element.style.display = "none";
        });
        
        inputElements.forEach(element => {
          element.classList.remove("input-error");
        });
      }
      
      // Mostrar mensaje de error de credenciales
      function showCredentialsError(message) {
        // Verificar si ya existe el elemento
        let credentialsError = document.getElementById('credentials-error');
        // Si no existe, crearlo
        if (!credentialsError) {
            credentialsError = document.createElement('div');
            credentialsError.id = 'credentials-error';
            credentialsError.className = 'error-message credentials-error-message';
            const form = document.getElementById('loginForm');
            const actionsDiv = form.querySelector('.recovery-actions');
            // Insertar antes del botón
            form.insertBefore(credentialsError, actionsDiv);
        }
        // Actualizar mensaje y mostrar
        credentialsError.textContent = message || "Credenciales incorrectas. Por favor, verifique su correo electrónico y contraseña.";
        credentialsError.style.display = "block";
      }
      
      // ===== FUNCIONES PRINCIPALES =====
      
      // Función para mostrar el formulario de recuperación
      window.showRecoveryForm = function() {
        // Limpiar errores de validación
        clearValidationErrors('loginForm');
        
        const loginContainer = document.getElementById('loginContainer');
        const recoveryForm = document.getElementById('recoveryForm');
        
        if (loginContainer) loginContainer.style.display = 'none';
        if (recoveryForm) recoveryForm.style.display = 'block';
        
        // Asegurar que solo se muestra el paso de email
        const stepEmail = document.getElementById('step-email');
        const stepPassword = document.getElementById('step-password');
        const stepSuccess = document.getElementById('step-success');
        const stepError = document.getElementById('step-error');
        const stepLoading = document.getElementById('step-loading');
        
        if (stepEmail) stepEmail.classList.add('active');
        if (stepPassword) stepPassword.classList.remove('active');
        if (stepSuccess) stepSuccess.classList.remove('active');
        if (stepError) stepError.classList.remove('active');
        if (stepLoading) stepLoading.classList.remove('active');
        
        // Limpiar campo de email
        const emailField = document.getElementById('recoveryEmail');
        if (emailField) emailField.value = '';
        
        // Limpiar errores de validación
        clearValidationErrors('step-email');
        
        return false;
      };
      
      // Función para volver al inicio de sesión
      window.showLoginForm = function() {
        // Limpiar errores de validación
        clearValidationErrors('step-email');
        clearValidationErrors('step-password');
        
        const loginContainer = document.getElementById('loginContainer');
        const recoveryForm = document.getElementById('recoveryForm');
        
        if (recoveryForm) recoveryForm.style.display = 'none';
        if (loginContainer) loginContainer.style.display = 'block';
        
        // Limpiar errores de validación del login
        clearValidationErrors('loginForm');
        
        return false;
      };
      
      // Función para verificar email
      window.verifyUserEmail = function() {
        // Validar email con la nueva función de validación
        if (!validateEmail('recoveryEmail')) {
          return false;
        }
        
        const emailField = document.getElementById('recoveryEmail');
        if (!emailField) {
          return false;
        }
        
        const email = emailField.value.trim();
        
        // Mostrar indicador de carga
        Swal.fire({
          title: 'Verificando correo',
          text: 'Comprobando si el correo existe en el sistema...',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // Simular proceso de verificación (1.5 segundos)
        setTimeout(function() {
          Swal.close();
          
          // Mostrar paso de contraseña
          const stepEmail = document.getElementById('step-email');
          const stepPassword = document.getElementById('step-password');
          
          if (stepEmail) stepEmail.classList.remove('active');
          if (stepPassword) {
            stepPassword.classList.add('active');
            // Guardar email para uso posterior
            stepPassword.setAttribute('data-email', email);
          }
          
          // Limpiar campos de contraseña y validaciones
          const newPasswordField = document.getElementById('newPassword');
          const confirmPasswordField = document.getElementById('confirmPassword');
          
          if (newPasswordField) newPasswordField.value = '';
          if (confirmPasswordField) confirmPasswordField.value = '';
          
          clearValidationErrors('step-password');
          
        }, 1500);
        
        return false;
      };
      
      // Función para cambiar contraseña
      window.changePassword = function() {
        // Validar contraseñas usando las nuevas funciones
        const passwordValid = validatePassword('newPassword', 6);
        const confirmValid = validatePasswordMatch('newPassword', 'confirmPassword');
        
        // Si algún campo no es válido, detener el proceso
        if (!passwordValid || !confirmValid) {
          return false;
        }
        
        const newPasswordField = document.getElementById('newPassword');
        const confirmPasswordField = document.getElementById('confirmPassword');
        const passwordStep = document.getElementById('step-password');
        
        if (!newPasswordField || !confirmPasswordField || !passwordStep) {
          return false;
        }
        
        const newPassword = newPasswordField.value.trim();
        const confirmPassword = confirmPasswordField.value.trim();
        const email = passwordStep.getAttribute('data-email');
        
        // Mostrar indicador de carga
        Swal.fire({
          title: 'Actualizando contraseña',
          text: 'Procesando tu solicitud...',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // Simular proceso de cambio de contraseña (2 segundos)
        setTimeout(function() {
          Swal.fire({
            icon: 'success',
            title: '¡Contraseña actualizada!',
            text: 'Tu contraseña ha sido actualizada correctamente. Ahora puedes iniciar sesión.'
          }).then(() => {
            const stepPassword = document.getElementById('step-password');
            const stepSuccess = document.getElementById('step-success');
            
            if (stepPassword) stepPassword.classList.remove('active');
            if (stepSuccess) stepSuccess.classList.add('active');
          });
        }, 2000);
        
        return false;
      };
      
      // Función para mostrar paso de email
      window.showEmailStep = function() {
        const stepEmail = document.getElementById('step-email');
        const stepPassword = document.getElementById('step-password');
        const stepSuccess = document.getElementById('step-success');
        const stepError = document.getElementById('step-error');
        const stepLoading = document.getElementById('step-loading');
        
        if (stepEmail) stepEmail.classList.add('active');
        if (stepPassword) stepPassword.classList.remove('active');
        if (stepSuccess) stepSuccess.classList.remove('active');
        if (stepError) stepError.classList.remove('active');
        if (stepLoading) stepLoading.classList.remove('active');
        
        // Limpiar validaciones al cambiar de paso
        clearValidationErrors('step-email');
        
        return false;
      };
      
      // ===== VALIDACIÓN DEL FORMULARIO DE LOGIN =====
      
      // API endpoints
      const API_URL = "https://backend-yy4o.onrender.com/api";
      const API_LOGIN = `${API_URL}/auth/login`;
      
      // Agregar validación al formulario de login
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        // Agregar validación en tiempo real
        const emailField = document.getElementById('email');
        const passwordField = document.getElementById('password');
        
        if (emailField) {
          emailField.addEventListener('blur', () => validateEmail('email'));
          // Limpiar mensaje de error de credenciales al cambiar el correo
          emailField.addEventListener('input', () => {
            const credentialsError = document.getElementById('credentials-error');
            if (credentialsError) credentialsError.style.display = "none";
          });
        }
        
        if (passwordField) {
          passwordField.addEventListener('blur', () => validatePassword('password', 0));
          // Limpiar mensaje de error de credenciales al cambiar la contraseña
          passwordField.addEventListener('input', () => {
            const credentialsError = document.getElementById('credentials-error');
            if (credentialsError) credentialsError.style.display = "none";
          });
        }
        
        // Validar al enviar el formulario
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validar campos
          const emailValid = validateEmail('email');
          const passwordValid = validatePassword('password', 0);
          
          // Si algún campo no es válido, detener el proceso
          if (!emailValid || !passwordValid) {
            return false;
          }
          
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value.trim();
          
          try {
            // Mostrar indicador de carga
            Swal.fire({
              title: 'Procesando',
              text: 'Verificando credenciales...',
              allowOutsideClick: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });
            
            const response = await fetch(API_LOGIN, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                email,
                password
              })
            });
            
            const result = await response.json();
            
            // Procesar respuesta
            if (response.ok) {
              await Swal.fire({
                icon: 'success',
                title: '¡Bienvenido!',
                text: 'Inicio de sesión exitosa',
                timer: 1500,
                showConfirmButton: false
              });
              
              // Guardar token y redireccionar
              localStorage.setItem('token', result.token);
              window.location.href = "home.html";
            } else {
              // Cerrar SweetAlert
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: result.message || "Credenciales inválidas",
                confirmButtonColor: '#2e3b52'
              });
              
              // Mostrar mensaje de error en el formulario
              showCredentialsError(result.message || "Credenciales incorrectas. Por favor, verifique su correo electrónico y contraseña.");
            }
          } catch (error) {
            console.error("Error al iniciar sesión:", error);
            
            // Cerrar SweetAlert
            Swal.fire({
              icon: 'error',
              title: 'Error de conexión',
              text: 'No se pudo conectar con el servidor',
              confirmButtonColor: '#2e3b52'
            });
            
            // Mostrar mensaje de error en el formulario
            showCredentialsError("Error de conexión. No se pudo conectar con el servidor.");
          }
        });
      }
      
      // ===== VALIDACIÓN DEL FORMULARIO DE RECUPERACIÓN =====
      
      // Agregar validación en tiempo real para los campos de recuperación
      const recoveryEmail = document.getElementById('recoveryEmail');
      if (recoveryEmail) {
        recoveryEmail.addEventListener('blur', () => validateEmail('recoveryEmail'));
      }
      
      const newPassword = document.getElementById('newPassword');
      if (newPassword) {
        newPassword.addEventListener('blur', () => validatePassword('newPassword', 6));
        // Validar también la confirmación cuando cambia la contraseña
        newPassword.addEventListener('input', () => {
          const confirmField = document.getElementById('confirmPassword');
          if (confirmField && confirmField.value.trim()) {
            validatePasswordMatch('newPassword', 'confirmPassword');
          }
        });
      }
      
      const confirmPassword = document.getElementById('confirmPassword');
      if (confirmPassword) {
        confirmPassword.addEventListener('blur', () => validatePasswordMatch('newPassword', 'confirmPassword'));
        confirmPassword.addEventListener('input', () => validatePasswordMatch('newPassword', 'confirmPassword'));
      }
      
      // Desactivar validación nativa del navegador
      function disableNativeBrowserValidation() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
          form.setAttribute("novalidate", "");
          
          // Quitar atributos 'required' y 'pattern' de los campos
          const inputs = form.querySelectorAll("input");
          inputs.forEach(input => {
            input.removeAttribute("required");
            input.removeAttribute("pattern");
          });
        });
      }
      
      // Ejecutar desactivación de validación nativa
      disableNativeBrowserValidation();
    });
  </script>
</body>
</html>